# CloudPayments модуль для OpenCart
Модуль позволит с легкостью добавить на ваш сайт оплату банковскими картами через платежный сервис CloudPayments. 
Для корректной работы модуля необходима регистрация в сервисе.

Порядок регистрации описан в [документации CloudPayments](https://cloudpayments.ru/Docs/Connect)

### Возможности
* Одностадийная схема оплаты;
* Двухстадийная схема оплаты;
* Отмена, подтверждение и возврат платежей из ЛК CMS;
* Локализация виджета оплаты
* Поддержка онлайн-касс (ФЗ-54);
* Настройка НДС для службы доставки;
* Отправка чеков по email;
* Отправка чеков по SMS;

### Совместимость
OpenCart v.3.0 и выше;

### Установка через панель управления

В панели адмниистратора зайти в раздел "Модули/Расширения" -> "Установка расширений" и загрузить архив.

### Ручная установка

Распаковать из архива каталог upload и загрузить в корень OpenCart.

### Настройка модуля

1. Перейти в настройки модуля "Модули/Расширения" -> "Модули/Расширения" -> "Оплата".
Выбрать CloudPayments и активировать модуль.
2. Зайти в настройки модуля и указать:
    * Идентификатор сайта — Public id сайта из личного кабинета CloudPayments
    * Секретный ключ — API Secret из личного кабинета CloudPayments
    * Статус - включено
    
    Затем сохранить введенные параметры.
    
    Дополнительно можно также указать: регионы, для которых будет действовать метод оплаты,
    минимальную сумму заказа, порядок сортировки при выводе методов оплаты.
    А также включить двухстадийную оплату, формирвание онлайн-чека и настроить требуемые статусы заказа
    на определенные события.
3. В личном кабинете CloudPayments указать URL уведомлений со вкладки "Уведомления"    

### Двухстадийная оплата

В этом режиме оплата происходит в два этапа: авторизация платежа (блокировка суммы на карте покупателя)
и подтверждение списания.
Для работы модуля в этом режиме могут потребоваться дополнительные статусы заказа:

* Авторизован — На данный статус заказ переводится при получении уведомления об авторизации оплаты.
    По умолчанию заказ переводится в статус "Ожидание"
* Подтвержден — При перевода заказа на данный статус отправляется запрос на подтверждение оплаты.
    Необходим если требуется подтверждать заказ до отправки.
    По умолчанию оплата подтверждается при смене статуса на "Сделка завершена"
        
Данные статусы можно создать в "Система" -> "Локализация" -> "Статусы заказов".
А настроить их на требуемые события в настройках модуля (вкладка "Статусы"). 
Также в настройках модуля требуется включить двухстадийную оплату установив значение
соответствущего параметра в "включено".

### Интеграция с онлайн-кассой

Модуль позволяет интегрировать онлайн-кассу при оплате и отменах платежей.
Для этого подключить кассу в личном кабинете CloudPayments https://cloudpayments.ru/Docs/Kassa и указать дополнительные настройки модуля:

* Формировать онлайн-чек — Включено
* Ставка НДС — Указание ставки НДС.
Все возможные значения указаны в документации https://cloudpayments.ru/Docs/Kassa#data-format
* Ставка НДС для доставки — Указание отдельной ставки НДС для доставки.
Если доставка платная, то она в чеке оформляется отдельной строкой со своей ставкой НДС.
Значения аналогично ставке НДС для товаров.
* Система налогообложения — Тип системы налогообложения.
Возможные значения перечислены в документации CloudPayments https://cloudpayments.ru/Docs/Directory#taxation-system
